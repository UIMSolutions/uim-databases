#!/usr/bin/env dub
/+ dub.sdl:
    dependency "vibe-d" version="~>0.9.0"
+/
module object-example;

import std.stdio;
import std.net.curl;
import vibe.data.json;
import std.conv;

void main() {
    writeln("=== Object Database Example Client ===\n");
    
    string baseUrl = "http://localhost:8081";
    
    // Check server health
    writeln("1. Checking server health...");
    try {
        auto healthResponse = get(baseUrl ~ "/health");
        auto health = parseJSON(healthResponse);
        writeln("✓ Server is running");











































































































































































































































}    writeln("    -d '{\"where\": [{\"field\": \"age\", \"op\": \">\", \"value\": 25}]}'");    writeln("    -H 'Content-Type: application/json' \\");    writeln("  curl -X POST http://localhost:8081/collections/users/find \\");    writeln("  curl http://localhost:8081/collections/users/stats");    writeln("  curl http://localhost:8081/collections");    writeln("Try more queries with curl:");    writeln("\n=== Example Complete! ===\n");        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        }            writeln("    - ", coll["name"].str, " (", coll["documentCount"].integer, " documents)");        foreach (coll; result["collections"].array) {        writeln("  Total collections: ", result["count"].integer);        auto result = parseJSON(response);        auto response = get(baseUrl ~ "/collections");    try {    writeln("\n12. Listing all collections...");        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        writeln("  Indexes: ", stats["indexCount"].integer);        writeln("  Documents: ", stats["documentCount"].integer);        writeln("  Collection: ", stats["name"].str);        auto stats = parseJSON(response);        auto response = get(baseUrl ~ "/collections/users/stats");    try {    writeln("\n11. Getting collection statistics...");        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        writeln("  Inactive users count: ", result["count"].integer);        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           query.toString(),        auto response = post(baseUrl ~ "/collections/users/count",                query["where"] = conditions;                conditions ~= cond;        cond["value"] = false;        cond["op"] = "==";        cond["field"] = "active";        Json cond = Json.emptyObject;                Json conditions = Json.emptyArray;        Json query = Json.emptyObject;    try {    writeln("\n10. Counting documents...");        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        writeln("  ✓ Bulk inserted ", result["inserted"].integer, " documents");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           bulkReq.toString(),        auto response = post(baseUrl ~ "/collections/users/bulk",                bulkReq["documents"] = docs;                }            docs ~= doc;            doc["active"] = false;            doc["age"] = 18 + i;            doc["email"] = "bulk" ~ to!string(i) ~ "@example.com";            doc["name"] = "Bulk User " ~ to!string(i);            Json doc = Json.emptyObject;        foreach (i; 10 .. 15) {                Json docs = Json.emptyArray;        Json bulkReq = Json.emptyObject;    try {    writeln("\n9. Bulk insert operation...");        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        }                   ", active: ", doc["data"]["active"].get!bool, ")");                   " (age: ", doc["data"]["age"].integer,             writeln("    - ", doc["data"]["name"].str,         foreach (doc; result["documents"].array) {                writeln("  Found ", result["count"].integer, " active users with age >= 25:");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           query.toString(),        auto response = post(baseUrl ~ "/collections/users/find",                query["sort"] = sort;        sort["ascending"] = false;  // descending        sort["field"] = "age";        Json sort = Json.emptyObject;                query["where"] = conditions;                conditions ~= cond2;        cond2["value"] = true;        cond2["op"] = "==";        cond2["field"] = "active";        Json cond2 = Json.emptyObject;                conditions ~= cond1;        cond1["value"] = 25;        cond1["op"] = ">=";        cond1["field"] = "age";        Json cond1 = Json.emptyObject;                Json conditions = Json.emptyArray;        Json query = Json.emptyObject;    try {    writeln("\n8. Query with multiple conditions (age >= 25 AND active == true)...");        }        }            writeln("  Note: Update complete but response parsing may vary");        } catch (Exception e) {            writeln("  ✓ Document updated");                        client.perform();            client.onReceive = (ubyte[] data) { buffer ~= cast(string)data; return data.length; };            auto buffer = appender!string();            client.setPostData(updateDoc.toString(), "application/json");            client.addRequestHeader("Content-Type", "application/json");            client.method = HTTP.Method.put;            auto client = HTTP(baseUrl ~ "/collections/users/documents/" ~ userIds[0]);                        updateDoc["tags"] = serializeToJson(["updated", "modified"]);            updateDoc["active"] = true;            updateDoc["age"] = 99;            updateDoc["email"] = "updated@example.com";            updateDoc["name"] = "Updated User";            Json updateDoc = Json.emptyObject;        try {    if (userIds.length > 0) {    writeln("\n7. Updating a document...");        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        writeln("  ✓ Index created on 'email'");                           ["Content-Type": "application/json"]);                           indexReq.toString(),        auto response = post(baseUrl ~ "/collections/users/indexes",                indexReq["field"] = "email";        Json indexReq = Json.emptyObject;    try {    writeln("\n6. Creating an index on 'email' field...");        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        }            writeln("    - ", doc["data"]["name"].str, " (age: ", doc["data"]["age"].integer, ")");        foreach (doc; result["documents"].array) {                writeln("  Found ", result["count"].integer, " documents:");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           query.toString(),        auto response = post(baseUrl ~ "/collections/users/find",                query["limit"] = 10;        query["where"] = conditions;                conditions ~= cond;        cond["value"] = 30;        cond["op"] = ">";        cond["field"] = "age";        Json cond = Json.emptyObject;                Json conditions = Json.emptyArray;        Json query = Json.emptyObject;    try {    writeln("\n5. Querying documents (age > 30)...");        }        }            writeln("  ✗ Failed: ", e.msg);        } catch (Exception e) {            writeln("  Age: ", doc["data"]["age"].integer);            writeln("  Email: ", doc["data"]["email"].str);            writeln("  Name: ", doc["data"]["name"].str);            writeln("  Document ID: ", doc["_id"].str[0..8], "...");            auto doc = parseJSON(response);            auto response = get(baseUrl ~ "/collections/users/documents/" ~ userIds[0]);        try {    if (userIds.length > 0) {    writeln("\n4. Getting a specific document...");        }        }            writeln("  ✗ Failed to insert: ", e.msg);        } catch (Exception e) {            writeln("  ✓ Inserted: ", doc["name"].str, " (ID: ", id[0..8], "...)");            userIds ~= id;            string id = result["id"].str;            auto result = parseJSON(response);                               ["Content-Type": "application/json"]);                               doc.toString(),            auto response = post(baseUrl ~ "/collections/users/documents",        try {                doc["tags"] = serializeToJson(["tag" ~ to!string(i), "user"]);        doc["active"] = i % 2 == 0;        doc["age"] = 20 + i * 5;        doc["email"] = "user" ~ to!string(i) ~ "@example.com";        doc["name"] = "User " ~ to!string(i);        Json doc = Json.emptyObject;    foreach (i; 1 .. 6) {    // Insert user documents        string[] userIds;    writeln("\n3. Inserting documents...");        }        writeln("  (Collection may already exist)");    } catch (Exception e) {        writeln("✓ Collection 'users' created");        auto response = post(baseUrl ~ "/collections/users", "", ["Content-Type": "application/json"]);    try {    writeln("\n2. Creating a new collection 'users'...");        }        return;        writeln("✗ Server not responding. Run: dub --config=object");    } catch (Exception e) {        writeln("  Collections: ", health["collections"].integer);        writeln("  Type: ", health["type"].str);