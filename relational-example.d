#!/usr/bin/env dub
/+ dub.sdl:
    dependency "vibe-d" version="~>0.9.0"
+/
module relational-example;

import std.stdio;
import std.net.curl;
import vibe.data.json;
import std.conv;

void main() {
    writeln("=== Relational Database Example Client ===\n");
    
    string baseUrl = "http://localhost:8082";
    
    // Check server health
    writeln("1. Checking server health...");
    try {
        auto healthResponse = get(baseUrl ~ "/health");
        auto health = parseJSON(healthResponse);
        writeln("✓ Server is running");










































































































































































































































































































































































































}    writeln("    -d '{\"set\": {\"active\": true}, \"where\": [{\"column\": \"id\", \"op\": \"=\", \"value\": 1}]}'");    writeln("    -H 'Content-Type: application/json' \\");    writeln("  curl -X POST http://localhost:8082/tables/users/update \\");    writeln("\n  # UPDATE");    writeln("    -d '{\"columns\": [\"*\"]}'");    writeln("    -H 'Content-Type: application/json' \\");    writeln("  curl -X POST http://localhost:8082/tables/users/select \\");    writeln("  # SELECT");    writeln("Try SQL-like queries with curl:");    writeln("\n=== Example Complete! ===\n");        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        writeln("  ✓ Deleted ", result["deleted"].integer, " rows");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           deleteQuery.toString(),        auto response = post(baseUrl ~ "/tables/users/delete",                deleteQuery["where"] = where;        where ~= cond;        cond["value"] = 25;        cond["op"] = "<";        cond["column"] = "age";        Json cond = Json.emptyObject;        Json where = Json.emptyArray;                Json deleteQuery = Json.emptyObject;    try {    writeln("\n16. DELETE FROM users WHERE age < 25...");    // DELETE        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        }                   table["columnCount"].integer, " columns");                   table["rowCount"].integer, " rows, ",            writeln("    - ", table["name"].str, ": ",         foreach (table; stats["tables"].array) {        writeln("  Tables: ", stats["tableCount"].integer);        writeln("  Database: ", stats["name"].str);        auto stats = parseJSON(response);        auto response = get(baseUrl ~ "/stats");    try {    writeln("\n15. Getting database statistics...");    // Database stats        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        writeln("  Active users: ", result["count"].integer);        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           query.toString(),        auto response = post(baseUrl ~ "/tables/users/select",                query["where"] = where;        where ~= cond;        cond["value"] = true;        cond["op"] = "=";        cond["column"] = "active";        Json cond = Json.emptyObject;        Json where = Json.emptyArray;                query["columns"] = serializeToJson(["*"]);        Json query = Json.emptyObject;    try {    writeln("\n14. Counting active users...");    // COUNT        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        writeln("  User: ", user["name"].str, " (", user["email"].str, ")");        auto user = result["row"];        auto result = parseJSON(response);        auto response = get(baseUrl ~ "/tables/users/rows/1");    try {    writeln("\n13. Getting user by primary key (id=1)...");    // Get by primary key        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        }            writeln("    ... and ", result["count"].integer - 3, " more");        if (result["count"].integer > 3) {        }            }                       " | Amount: $", row["orders.amount"].get!double);                       " | Product: ", row["orders.product"].str,                writeln("    - User: ", row["users.name"].str,            if (i < 3) {  // Show first 3        foreach (i, row; result["rows"].array) {        writeln("  Found ", result["count"].integer, " joined rows:");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           join.toString(),        auto response = post(baseUrl ~ "/join",                join["rightColumn"] = "user_id";        join["leftColumn"] = "id";        join["rightTable"] = "orders";        join["leftTable"] = "users";        Json join = Json.emptyObject;    try {    writeln("\n12. INNER JOIN users and orders...");    // INNER JOIN        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        writeln("  ✓ Updated ", result["updated"].integer, " rows");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           update.toString(),        auto response = post(baseUrl ~ "/tables/users/update",                update["where"] = where;        where ~= cond;        cond["value"] = 35;        cond["op"] = ">";        cond["column"] = "age";        Json cond = Json.emptyObject;        Json where = Json.emptyArray;                update["set"] = set;        set["active"] = false;        Json set = Json.emptyObject;        Json update = Json.emptyObject;    try {    writeln("\n11. UPDATE users SET active = false WHERE age > 35...");    // UPDATE        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        }            writeln("    - ", row["name"].str, " (age: ", row["age"].get!long, ")");        foreach (row; result["rows"].array) {        writeln("  Users ordered by age (descending):");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           query.toString(),        auto response = post(baseUrl ~ "/tables/users/select",                query["ascending"] = false;        query["orderBy"] = "age";        query["columns"] = serializeToJson(["*"]);        Json query = Json.emptyObject;    try {    writeln("\n10. SELECT * FROM users ORDER BY age DESC...");    // SELECT with ORDER BY        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        }            writeln("    - ", row["name"].str, " (age: ", row["age"].get!long, ")");        foreach (row; result["rows"].array) {        writeln("  Found ", result["count"].integer, " users:");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           query.toString(),        auto response = post(baseUrl ~ "/tables/users/select",                query["where"] = where;        where ~= cond;        cond["value"] = 30;        cond["op"] = ">";        cond["column"] = "age";        Json cond = Json.emptyObject;        Json where = Json.emptyArray;                query["columns"] = serializeToJson(["*"]);        Json query = Json.emptyObject;    try {    writeln("\n9. SELECT * FROM users WHERE age > 30...");    // SELECT with WHERE clause        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        }                   " Active:", row["active"].get!bool);                   " Age:", row["age"].get!long,                   " Name:", row["name"].str,            writeln("    - ID:", row["id"].get!long,         foreach (row; result["rows"].array) {        writeln("  Found ", result["count"].integer, " users:");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           query.toString(),        auto response = post(baseUrl ~ "/tables/users/select",                query["columns"] = serializeToJson(["*"]);        Json query = Json.emptyObject;    try {    writeln("\n8. SELECT * FROM users...");    // SELECT all users        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        }            writeln("    - ", col["name"].str, " (", col["type"].str, ")");        foreach (col; schema["columns"].array) {        writeln("  Columns:");        writeln("  Primary Key: ", schema["primaryKey"].str);        writeln("  Table: ", schema["tableName"].str);        auto schema = parseJSON(response);        auto response = get(baseUrl ~ "/tables/users/schema");    try {    writeln("\n7. Getting 'users' table schema...");    // Get schema        }        writeln("  ✗ Failed: ", e.msg);    } catch (Exception e) {        writeln("  Tables: ", result["tables"]);        auto result = parseJSON(response);        auto response = get(baseUrl ~ "/tables");    try {    writeln("\n6. Listing all tables...");    // List tables        }        writeln("  Note: ", e.msg);    } catch (Exception e) {        writeln("  ✓ Inserted ", result["inserted"].integer, " orders");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           bulkInsert.toString(),        auto response = post(baseUrl ~ "/tables/orders/insert",                bulkInsert["rows"] = rows;                }            }                rows ~= order;                order["amount"] = 10.5 * orderId;                order["product"] = "Product " ~ to!string(j + 1);                order["user_id"] = userId;                order["id"] = orderId++;                Json order = Json.emptyObject;            foreach (j; 0 .. 2) {        foreach (userId; 1 .. 4) {        int orderId = 1;                Json rows = Json.emptyArray;        Json bulkInsert = Json.emptyObject;    try {    writeln("\n5. Inserting orders...");    // Insert orders        }        writeln("  Note: ", e.msg);    } catch (Exception e) {        writeln("  ✓ Inserted ", result["inserted"].integer, " users");        auto result = parseJSON(response);                           ["Content-Type": "application/json"]);                           bulkInsert.toString(),        auto response = post(baseUrl ~ "/tables/users/insert",                bulkInsert["rows"] = rows;                }            rows ~= user;            user["active"] = i % 2 == 1;            user["age"] = 20 + i * 5;            user["email"] = "user" ~ to!string(i) ~ "@example.com";            user["name"] = "User " ~ to!string(i);            user["id"] = i;            Json user = Json.emptyObject;        foreach (i; 1 .. 6) {                Json rows = Json.emptyArray;        Json bulkInsert = Json.emptyObject;    try {    writeln("\n4. Inserting users...");    // Insert users        }        writeln("  (Table may already exist)");    } catch (Exception e) {        writeln("✓ Table 'orders' created with foreign key to users");                           ["Content-Type": "application/json"]);                           createTable.toString(),        auto response = post(baseUrl ~ "/tables",                createTable["foreignKeys"] = foreignKeys;        foreignKeys ~= fk;        fk["refColumn"] = "id";        fk["refTable"] = "users";        fk["column"] = "user_id";        Json fk = Json.emptyObject;        Json foreignKeys = Json.emptyArray;        // Add foreign key                createTable["columns"] = columns;                columns ~= amountCol;        amountCol["nullable"] = false;        amountCol["type"] = "FLOAT";        amountCol["name"] = "amount";        Json amountCol = Json.emptyObject;                columns ~= productCol;        productCol["nullable"] = false;        productCol["type"] = "STRING";        productCol["name"] = "product";        Json productCol = Json.emptyObject;                columns ~= userIdCol;        userIdCol["nullable"] = false;        userIdCol["type"] = "INTEGER";        userIdCol["name"] = "user_id";        Json userIdCol = Json.emptyObject;                columns ~= idCol;        idCol["primaryKey"] = true;        idCol["nullable"] = false;        idCol["type"] = "INTEGER";        idCol["name"] = "id";        Json idCol = Json.emptyObject;                Json columns = Json.emptyArray;                createTable["name"] = "orders";        Json createTable = Json.emptyObject;    try {    writeln("\n3. Creating 'orders' table with foreign key...");    // Create Orders table        }        writeln("  (Table may already exist)");    } catch (Exception e) {        writeln("✓ Table 'users' created");                           ["Content-Type": "application/json"]);                           createTable.toString(),        auto response = post(baseUrl ~ "/tables",                createTable["columns"] = columns;                columns ~= activeCol;        activeCol["default"] = true;        activeCol["nullable"] = false;        activeCol["type"] = "BOOLEAN";        activeCol["name"] = "active";        Json activeCol = Json.emptyObject;                columns ~= ageCol;        ageCol["nullable"] = true;        ageCol["type"] = "INTEGER";        ageCol["name"] = "age";        Json ageCol = Json.emptyObject;                columns ~= emailCol;        emailCol["unique"] = true;        emailCol["nullable"] = false;        emailCol["type"] = "STRING";        emailCol["name"] = "email";        Json emailCol = Json.emptyObject;                columns ~= nameCol;        nameCol["nullable"] = false;        nameCol["type"] = "STRING";        nameCol["name"] = "name";        Json nameCol = Json.emptyObject;                columns ~= idCol;        idCol["primaryKey"] = true;        idCol["nullable"] = false;        idCol["type"] = "INTEGER";        idCol["name"] = "id";        Json idCol = Json.emptyObject;                Json columns = Json.emptyArray;                createTable["name"] = "users";        Json createTable = Json.emptyObject;    try {    writeln("\n2. Creating 'users' table...");    // Create Users table        }        return;        writeln("✗ Server not responding. Run: dub --config=relational");    } catch (Exception e) {        writeln("  Tables: ", health["tableCount"].integer);        writeln("  Type: ", health["type"].str);