module app;

import vibe.vibe;
import vibe.data.json;
import std.conv;
import std.algorithm;
import std.array;
import vectordb;
import vectorops;

/// Request model for adding a vector
struct AddVectorRequest {
    string id;
    double[] vector;
    string[string] metadata;
}

/// Request model for searching
struct SearchRequest {
    double[] vector;
    int k = 10;
}

































































































































































































































































































}    }        res.writeJsonBody(response);        res.statusCode = 400;        response["error"] = e.msg;        response["success"] = false;        auto response = Json.emptyObject;    } catch (Exception e) {        res.writeJsonBody(response);                response["message"] = "All vectors cleared";        response["success"] = true;        auto response = Json.emptyObject;                (cast(VectorDatabase)db).clear();    try {void handleClear(HTTPServerRequest req, HTTPServerResponse res) {}    res.writeJsonBody(response);        response["metric"] = "COSINE";    response["dimension"] = (cast(VectorDatabase)db).getDimension;    response["vectorCount"] = (cast(VectorDatabase)db).count;    auto response = Json.emptyObject;void handleStats(HTTPServerRequest req, HTTPServerResponse res) {}    }        res.writeJsonBody(response);        res.statusCode = 400;        response["error"] = e.msg;        response["success"] = false;        auto response = Json.emptyObject;    } catch (Exception e) {        res.writeJsonBody(response);                response["count"] = resultsJson.length;        response["results"] = serializeToJson(resultsJson);        auto response = Json.emptyObject;                }            resultsJson ~= resultObj;            resultObj["metadata"] = serializeToJson(result.vector.metadata);            resultObj["vector"] = serializeToJson(result.vector.values);            resultObj["distance"] = result.distance;            resultObj["id"] = result.vector.id;            auto resultObj = Json.emptyObject;        foreach (result; results) {        Json[] resultsJson;                auto results = (cast(VectorDatabase)db).searchById(id, k);                }            k = body["k"].get!int;        if ("k" in body) {        int k = 10;                auto body = req.json;        auto id = req.params["id"];    try {void handleSearchById(HTTPServerRequest req, HTTPServerResponse res) {}    }        res.writeJsonBody(response);        res.statusCode = 400;        response["error"] = e.msg;        response["success"] = false;        auto response = Json.emptyObject;    } catch (Exception e) {        res.writeJsonBody(response);                response["count"] = resultsJson.length;        response["results"] = serializeToJson(resultsJson);        auto response = Json.emptyObject;                }            resultsJson ~= resultObj;            resultObj["metadata"] = serializeToJson(result.vector.metadata);            resultObj["vector"] = serializeToJson(result.vector.values);            resultObj["distance"] = result.distance;            resultObj["id"] = result.vector.id;            auto resultObj = Json.emptyObject;        foreach (result; results) {        Json[] resultsJson;                auto results = (cast(VectorDatabase)db).search(queryVector, k);                }            k = body["k"].get!int;        if ("k" in body) {        int k = 10;                double[] queryVector = vectorArray.map!(v => v.get!double).array;        auto vectorArray = body["vector"].get!(Json[]);                auto body = req.json;    try {void handleSearch(HTTPServerRequest req, HTTPServerResponse res) {}    }        res.writeJsonBody(response);        res.statusCode = 400;        response["error"] = e.msg;        response["success"] = false;        auto response = Json.emptyObject;    } catch (Exception e) {        res.writeJsonBody(response);                response["ids"] = serializeToJson(ids);        response["count"] = ids.length;        auto response = Json.emptyObject;                auto ids = (cast(VectorDatabase)db).getAllIds();    try {void handleListVectors(HTTPServerRequest req, HTTPServerResponse res) {}    }        res.writeJsonBody(response);        res.statusCode = 400;        response["error"] = e.msg;        response["success"] = false;        auto response = Json.emptyObject;    } catch (Exception e) {        res.writeJsonBody(response);        res.statusCode = deleted ? 200 : 404;                response["message"] = deleted ? "Vector deleted successfully" : "Vector not found";        response["success"] = deleted;        auto response = Json.emptyObject;                bool deleted = (cast(VectorDatabase)db).deleteVector(id);        auto id = req.params["id"];    try {void handleDeleteVector(HTTPServerRequest req, HTTPServerResponse res) {}    }        res.writeJsonBody(response);        res.statusCode = 400;        response["error"] = e.msg;        response["success"] = false;        auto response = Json.emptyObject;    } catch (Exception e) {        res.writeJsonBody(response);                response["message"] = "Vector updated successfully";        response["id"] = id;        response["success"] = true;        auto response = Json.emptyObject;                (cast(VectorDatabase)db).updateVector(id, newVector, newMetadata);                }            }                newMetadata[key] = value.get!string;                if (newMetadata is null) newMetadata = string[string].init;            foreach (key, value; metadataJson) {            auto metadataJson = body["metadata"].get!(Json[string]);            newMetadata = null;        if ("metadata" in body) {        string[string] newMetadata = null;                }            newVector = vectorArray.map!(v => v.get!double).array;            auto vectorArray = body["vector"].get!(Json[]);        if ("vector" in body) {        double[] newVector = null;                auto body = req.json;        auto id = req.params["id"];    try {void handleUpdateVector(HTTPServerRequest req, HTTPServerResponse res) {}    }        res.writeJsonBody(response);        res.statusCode = 404;        response["error"] = e.msg;        response["success"] = false;        auto response = Json.emptyObject;    } catch (Exception e) {        res.writeJsonBody(response);                response["dimension"] = vec.dimension;        response["metadata"] = serializeToJson(vec.metadata);        response["vector"] = serializeToJson(vec.values);        response["id"] = vec.id;        auto response = Json.emptyObject;                auto vec = (cast(VectorDatabase)db).getVector(id);        auto id = req.params["id"];    try {void handleGetVector(HTTPServerRequest req, HTTPServerResponse res) {}    }        res.writeJsonBody(response);        res.statusCode = 400;        response["error"] = e.msg;        response["success"] = false;        auto response = Json.emptyObject;    } catch (Exception e) {        res.writeJsonBody(response);        res.statusCode = 201;                response["message"] = "Vector added successfully";        response["id"] = id;        response["success"] = true;        auto response = Json.emptyObject;                (cast(VectorDatabase)db).addVector(vec);        auto vec = Vector(id, vector, metadata);                }            }                metadata[key] = value.get!string;            foreach (key, value; metadataJson) {            auto metadataJson = body["metadata"].get!(Json[string]);        if ("metadata" in body) {        string[string] metadata;                double[] vector = vectorArray.map!(v => v.get!double).array;        auto vectorArray = body["vector"].get!(Json[]);        auto id = body["id"].get!string;                auto body = req.json;    try {void handleAddVector(HTTPServerRequest req, HTTPServerResponse res) {}    res.writeJsonBody(response);    response["dimension"] = (cast(VectorDatabase)db).getDimension;    response["vectorCount"] = (cast(VectorDatabase)db).count;    response["status"] = "healthy";    auto response = Json.emptyObject;void handleHealth(HTTPServerRequest req, HTTPServerResponse res) {}    res.writeBody("Vector Database API - Use /health for status", "text/plain");void handleIndex(HTTPServerRequest req, HTTPServerResponse res) {}    runApplication();    listenHTTP(settings, router);        logInfo("Database dimension: 128, Metric: COSINE");    logInfo("Vector Database REST API starting on port 8080...");    router.delete("/clear", &handleClear);    router.get("/stats", &handleStats);    // Database operations        router.post("/search/:id", &handleSearchById);    router.post("/search", &handleSearch);    // Search operations        router.get("/vectors", &handleListVectors);    router.delete("/vectors/:id", &handleDeleteVector);    router.put("/vectors/:id", &handleUpdateVector);    router.get("/vectors/:id", &handleGetVector);    router.post("/vectors", &handleAddVector);    // Vector CRUD operations        router.get("/health", &handleHealth);    router.get("/", &handleIndex);    // Health check endpoint        auto router = new URLRouter;    settings.bindAddresses = ["::1", "127.0.0.1"];    settings.port = 8080;    auto settings = new HTTPServerSettings;    db = cast(shared) new VectorDatabase(128, DistanceMetric.COSINE);    // Initialize the database with 128 dimensions (common for embeddings)void main() {shared VectorDatabase db;/// Global vector database instance}    string[string] metadata;    double[] vector;struct UpdateVectorRequest {
/// Request model for updating a vector